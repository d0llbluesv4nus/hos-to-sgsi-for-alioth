name: Build HyperOS SGSI (Enhanced)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: '–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ Recovery ROM (HyperOS/MIUI)'
        required: true
        default: ''
      android_version:
        description: '–í–µ—Ä—Å–∏—è Android (13, 14, 15)'
        required: true
        default: '14'
      repack_type:
        description: '–¢–∏–ø —É–ø–∞–∫–æ–≤–∫–∏ (erofs –∏–ª–∏ sparse)'
        required: true
        default: 'erofs'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: –û—á–∏—Å—Ç–∫–∞ –º–µ—Å—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
        run: |
          docker rmi `docker images -q`
          sudo rm -rf /usr/share/dotnet /etc/mysql /etc/php /usr/local/lib/android
          sudo apt-get update
          sudo apt-get -y install python2 python2-dev python3 python3-pip git aria2 zip unzip tar brotli zstd openjdk-8-jdk android-sdk-libsparse-utils
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏–º–ª–∏–Ω–∫–∞ –¥–ª—è python2, —Ç–∞–∫ –∫–∞–∫ —Å—Ç–∞—Ä—ã–µ —Å–∫—Ä–∏–ø—Ç—ã —Ç—Ä–µ–±—É—é—Ç –∏–º–µ–Ω–Ω–æ "python"
          sudo ln -sf /usr/bin/python2 /usr/bin/python

      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ SGSI Build Tool
        run: |
          git clone --recurse-submodules https://github.com/Xiaoxindada/SGSI-build-tool.git -b 12 workspace
          sudo chmod -R 777 workspace
          cd workspace
          # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –≤–Ω—É—Ç—Ä–∏ —Ç—É–ª–∑—ã, –µ—Å–ª–∏ –æ–Ω–∏ —É—Å—Ç–∞—Ä–µ–ª–∏
          bash setup.sh || true

      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏ (ROM)
        run: |
          cd workspace
          echo "–°–∫–∞—á–∏–≤–∞—é –ø—Ä–æ—à–∏–≤–∫—É..."
          aria2c -x16 -s16 "${{ github.event.inputs.rom_url }}" -o firmware.zip

      - name: –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∏ –°–±–æ—Ä–∫–∞ SGSI
        run: |
          cd workspace
          # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ zip
          unzip firmware.zip -d firmware_files
          
          # –ê–≤—Ç–æ–ø–æ–∏—Å–∫ payload.bin –∏–ª–∏ system.new.dat.br
          if [ -f "firmware_files/payload.bin" ]; then
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω payload.bin, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ."
            mv firmware_files/payload.bin .
          elif [ -f "firmware_files/system.new.dat.br" ]; then
            echo "–û–±–Ω–∞—Ä—É–∂–µ–Ω –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç DAT.BR."
          fi

          # –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞ —Å–±–æ—Ä–∫–∏
          # --AB —É–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–∏–ø —Ä–∞–∑–¥–µ–ª–æ–≤, ${{ github.event.inputs.android_version }} - –≤–µ—Ä—Å–∏—é
          sudo ./make.sh --AB ${{ github.event.inputs.android_version }}

      - name: üõ† –ü–†–ò–ú–ï–ù–ï–ù–ò–ï –§–ò–ö–°–û–í (Advanced Patching)
        run: |
          cd workspace
          echo "–ú–æ–Ω—Ç–∏—Ä—É–µ–º –æ–±—Ä–∞–∑ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è —Ñ–∏–∫—Å–æ–≤..."
          
          # –°–æ–∑–¥–∞–µ–º —Ç–æ—á–∫—É –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          mkdir -p mount_point
          
          # –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º s.img (sparse) –≤ raw system.img, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ, –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Ç–æ–≤—ã–π
          if [ -f "SGSI/system.img" ]; then
             echo "–û–±—Ä–∞–∑ –Ω–∞–π–¥–µ–Ω."
          else
             echo "–û—à–∏–±–∫–∞: –û–±—Ä–∞–∑ SGSI –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω!" && exit 1
          fi

          # –ú–æ–Ω—Ç–∏—Ä—É–µ–º
          sudo mount -o loop,rw SGSI/system.img mount_point

          echo ">>> 1. –£–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –æ–≤–µ—Ä–ª–µ–µ–≤ (Anti-Bootloop)"
          # –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ –æ–≤–µ—Ä–ª–µ–∏ SystemUI –∏ Settings, –∫–æ—Ç–æ—Ä—ã–µ —á–∞—Å—Ç–æ –∫—Ä–∞—à–∞—Ç —Å–∏—Å—Ç–µ–º—É –Ω–∞ –¥—Ä—É–≥–æ–º –∂–µ–ª–µ–∑–µ
          sudo rm -rf mount_point/product/overlay/*MiuiSystemUI*
          sudo rm -rf mount_point/product/overlay/*Settings*
          # –£–¥–∞–ª—è–µ–º –æ–≤–µ—Ä–ª–µ–∏ —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è —É–≥–ª–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å (—á–∞—Å—Ç–æ –º–µ—à–∞—é—Ç)
          sudo rm -rf mount_point/product/overlay/*Rounded*

          echo ">>> 2. –§–∏–∫—Å—ã build.prop (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –û—Ç–ª–∞–¥–∫–∞)"
          # –†–∞–∑—Ä–µ—à–∞–µ–º –æ—Ç–ª–∞–¥–∫—É
          sudo sed -i 's/ro.secure=1/ro.secure=0/' mount_point/system/build.prop
          sudo sed -i 's/ro.debuggable=0/ro.debuggable=1/' mount_point/system/build.prop
          sudo sed -i 's/ro.adb.secure=1/ro.adb.secure=0/' mount_point/system/build.prop
          # –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫–ª—é—á–∏—Ç—å —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ —É—Ä–æ–≤–Ω–µ –ø—Ä–æ–ø–æ–≤ (–Ω–µ –≤—Å–µ–≥–¥–∞ –ø–æ–º–æ–≥–∞–µ—Ç –±–µ–∑ fstab, –Ω–æ –ø–æ–ª–µ–∑–Ω–æ)
          sudo echo "ro.crypto.state=unencrypted" | sudo tee -a mount_point/system/build.prop
          sudo echo "ro.secure=0" | sudo tee -a mount_point/system/build.prop

          echo ">>> 3. –£–¥–∞–ª–µ–Ω–∏–µ –º—É—Å–æ—Ä–∞ (Debloat)"
          # –£–¥–∞–ª—è–µ–º –¥–µ–º–æ–Ω—ã Xiaomi, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—ã–∑—ã–≤–∞—Ç—å –ø–µ—Ä–µ–≥—Ä–µ–≤ –Ω–∞ –Ω–µ-Xiaomi —è–¥—Ä–∞—Ö
          sudo rm -f mount_point/system/bin/mi_thermald
          sudo rm -f mount_point/vendor/bin/mi_thermald

          echo ">>> 4. –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–∞—Ç—á–µ–π (–µ—Å–ª–∏ –µ—Å—Ç—å)"
          # –ï—Å–ª–∏ —Ç—ã —Å–æ–∑–¥–∞–ª –ø–∞–ø–∫—É 'patches' –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏, —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–∫–æ–ø–∏—Ä—É–µ—Ç—Å—è –≤ —Å–∏—Å—Ç–µ–º—É
          if [ -d "../patches" ]; then
             echo "–ù–∞–π–¥–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –ø–∞—Ç—á–∏, –∫–æ–ø–∏—Ä—É–µ–º..."
             sudo cp -r ../patches/* mount_point/
          fi
          
          # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (SELinux fix attempt)
          sudo chmod 0600 mount_point/system/build.prop
          
          # –†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
          sudo umount mount_point
          echo "–§–∏–∫—Å—ã –ø—Ä–∏–º–µ–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ."

      - name: –£–ø–∞–∫–æ–≤–∫–∞ –≤ EROFS/Sparse
        run: |
          cd workspace
          
          if [ "${{ github.event.inputs.repack_type }}" == "erofs" ]; then
            echo "–£–ø–∞–∫–æ–≤–∫–∞ –≤ EROFS..."
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º mkfs.erofs (–æ–±—ã—á–Ω–æ –µ—Å—Ç—å –≤ build-tool –∏–ª–∏ —Å–∏—Å—Ç–µ–º–µ)
            # –ï—Å–ª–∏ –≤ —Å–∏—Å—Ç–µ–º–µ –Ω–µ—Ç, –∫–∞—á–∞–µ–º —Å—Ç–∞—Ç–∏—á–Ω—ã–π –±–∏–Ω–∞—Ä–Ω–∏–∫ (–Ω–∞–¥–µ–∂–Ω–µ–µ)
            wget https://github.com/sekaiacg/erofs-utils/raw/main/mkfs.erofs -O mkfs.erofs
            chmod +x mkfs.erofs
            
            # –°–æ–∑–¥–∞–µ–º EROFS –æ–±—Ä–∞–∑ –∏–∑ –ø–∞–ø–∫–∏ (–Ω–∞–º –Ω—É–∂–Ω–æ —Å–Ω–æ–≤–∞ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å img2simg logic)
            # –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –ü—Ä–æ—Å—Ç–æ–π –ø—É—Ç—å - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —É—Ç–∏–ª–∏—Ç—É —Ç—É–ª–∑—ã, –µ—Å–ª–∏ –æ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ä–µ–ø–∞–∫
            # –ù–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ —É–ø–∞–∫—É–µ–º system.img –æ–±—Ä–∞—Ç–Ω–æ —á–µ—Ä–µ–∑ img2simg –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω sparse, –∏–ª–∏ mkfs.erofs
            
            # –ü–æ—Å–∫–æ–ª—å–∫—É –º—ã –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–ª–∏ system.img (ext4 raw), –Ω–∞–º –Ω—É–∂–Ω–æ –µ–≥–æ —Å–∂–∞—Ç—å –∏–ª–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å
            ./mkfs.erofs -zlz4hc -C32768 system_erofs.img SGSI/system.img
            mv system_erofs.img Final_SGSI.img
          else
            echo "–£–ø–∞–∫–æ–≤–∫–∞ –≤ Sparse Image (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)..."
            img2simg SGSI/system.img Final_SGSI.img
          fi

      - name: –ó–∞–≥—Ä—É–∑–∫–∞ –≤ Release
        uses: softprops/action-gh-release@v1
        with:
          files: workspace/Final_SGSI.img
          name: HyperOS SGSI - ${{ github.event.inputs.android_version }}
          tag_name: v${{ github.run_number }}
          body: |
            **Source ROM:** ${{ github.event.inputs.rom_url }}
            **Android Version:** ${{ github.event.inputs.android_version }}
            **Patches Applied:**
            - Removed MiuiSystemUI/Settings Overlays
            - Disabled ForceEncrypt flags (props)
            - Enabled ADB & Debugging
            - Removed mi_thermald
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}          curl https://bootstrap.pypa.io/pip/2.7/get-pip.py --output get-pip.py
          sudo python2 get-pip.py
          
          sudo python2 -m pip install protobuf==3.17.3 backports.lzma
          
          sudo ln -sf /usr/bin/python2 /usr/bin/python

      # 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
      - name: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
        run: |
          sudo apt-get install -y git wget curl unzip tar zip android-sdk-libsparse-utils e2fsprogs simg2img img2simg aria2 brotli erofs-utils

      # 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SGSI Tool
      - name: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SGSI Tool
        run: |
          git clone --recurse-submodules https://github.com/Xiaoxindada/SGSI-build-tool.git -b 12
          sudo chmod -R 777 SGSI-build-tool

      # 5. –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
      - name: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –ø—Ä–æ—à–∏–≤–∫–∏
        run: |
          cd SGSI-build-tool
          mkdir -p tmp
          echo "–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤ –ø–∞–ø–∫—É tmp..."
          aria2c -x16 -s16 -o tmp/firmware.zip "${{ github.event.inputs.rom_url }}"

      # 6. –°–±–æ—Ä–∫–∞
      - name: –°–±–æ—Ä–∫–∞ SGSI
        run: |
          cd SGSI-build-tool
          echo "–ó–∞–ø—É—Å–∫ make.sh..."
          sudo bash make.sh --AB 14 tmp/firmware.zip --fix-bug

      # 7. –ü–ê–¢–ß–ò–ù–ì (–ò–°–ü–†–ê–í–õ–ï–ù–´ –û–®–ò–ë–ö–ò MKFS –ò FIND)
      - name: –ü–∞—Ç—á–∏–Ω–≥ –∏ –ü–µ—Ä–µ–ø–∞–∫–æ–≤–∫–∞ –¥–ª—è Poco F3
        run: |
          cd SGSI-build-tool
          
          # –ò—â–µ–º –æ–±—Ä–∞–∑
          IMG_FILE=$(find . -name "*system*.img" | grep -v "mount_point" | head -n 1)
          
          if [ ! -f "$IMG_FILE" ]; then
            echo "–û–®–ò–ë–ö–ê: –û–±—Ä–∞–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–±–æ—Ä–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å."
            exit 1
          fi
          echo "–ù–∞–π–¥–µ–Ω –æ–±—Ä–∞–∑: $IMG_FILE"

          # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è sparse -> raw
          if file "$IMG_FILE" | grep -q "Android sparse image"; then
             echo "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è sparse -> raw..."
             simg2img "$IMG_FILE" system_raw.img
             sudo rm -f "$IMG_FILE"
             mv system_raw.img "$IMG_FILE"
          fi

          # –†–∞—Å–ø–∞–∫–æ–≤–∫–∞
          echo "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –æ–±—Ä–∞–∑–∞..."
          mkdir -p mount_point
          mkdir -p extracted_root
          
          sudo mount -o loop "$IMG_FILE" mount_point
          # –ö–æ–ø–∏—Ä—É–µ–º —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø—Ä–∞–≤
          sudo cp -a mount_point/* extracted_root/
          sudo umount mount_point
          
          # –£–¥–∞–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω–∏–∫
          sudo rm -f "$IMG_FILE"

          echo "–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –ø–∞—Ç—á–µ–π..."
          
          # Fix 1: Build.prop
          sudo sed -i 's/ro.secure=1/ro.secure=0/g' extracted_root/system/build.prop || true
          sudo sed -i 's/ro.adb.secure=1/ro.adb.secure=0/g' extracted_root/system/build.prop || true
          sudo sed -i 's/ro.debuggable=0/ro.debuggable=1/g' extracted_root/system/build.prop || true
          
          # Fix 2: –û–≤–µ—Ä–ª–µ–∏
          sudo rm -rf extracted_root/product/overlay/DeviceConfig*.apk || true
          sudo rm -rf extracted_root/product/overlay/*MiuiSystemUI*.apk || true
          
          # Fix 3: Fstab (–ò–°–ü–†–ê–í–õ–ï–ù–û: –¥–æ–±–∞–≤–ª–µ–Ω–æ sudo find)
          FSTAB_FILE=$(sudo find extracted_root/system -name "fstab*" | head -n 1)
          if [ -n "$FSTAB_FILE" ]; then
             echo "–ü–∞—Ç—á–∏–º fstab: $FSTAB_FILE"
             sudo sed -i 's/,fileencryption=aes-256-xts:aes-256-cts:v2//g' "$FSTAB_FILE"
             sudo sed -i 's/,avb//g' "$FSTAB_FILE"
             sudo sed -i 's/forceencrypt//g' "$FSTAB_FILE"
             sudo sed -i 's/dm-verity//g' "$FSTAB_FILE"
          else
             echo "WARNING: fstab –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          fi
          
          echo "–£–ø–∞–∫–æ–≤–∫–∞ –æ–±—Ä–∞—Ç–Ω–æ –≤ EROFS..."
          # –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π lz4 –≤–º–µ—Å—Ç–æ LZ4HC
          sudo mkfs.erofs -zlz4 system_patched.img extracted_root/
          
          # –ú–µ–Ω—è–µ–º –≤–ª–∞–¥–µ–ª—å—Ü–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
          sudo chown $(whoami) system_patched.img
          
          # –ß–∏—Å—Ç–∫–∞
          sudo rm -rf extracted_root
          sudo rm -rf mount_point

      # 8. –†–µ–ª–∏–∑
      - name: –£–ø–∞–∫–æ–≤–∫–∞ –∏ –†–µ–ª–∏–∑
        uses: softprops/action-gh-release@v1
        if: success()
        with:
          files: SGSI-build-tool/system_patched.img
          tag_name: v${{ github.run_number }}
          name: HyperOS Port Build ${{ github.run_number }}
          body: |
            HyperOS Port for Poco F3 (Alioth).
            **–¢–∏–ø:** EROFS (Read-Only).
            **–°–∂–∞—Ç–∏–µ:** LZ4.
            **–£—Å—Ç–∞–Ω–æ–≤–∫–∞:**
            1. –ü—Ä–æ—à–∏—Ç—å `system_patched.img` –≤ —Ä–∞–∑–¥–µ–ª System Image.
            2. –°–¥–µ–ª–∞—Ç—å Format Data.
            Source: ${{ github.event.inputs.rom_url }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
