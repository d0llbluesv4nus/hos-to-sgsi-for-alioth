name: HOS to SGSI for Alioth (Fixed & Updated)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: '–ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ Recovery ROM (.zip) HyperOS/MIUI'
        required: true
        default: ''
      os_type:
        description: '–¢–∏–ø —Å–∏—Å—Ç–µ–º—ã (ab - –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö, a - –¥–ª—è —Å—Ç–∞—Ä—ã—Ö)'
        required: true
        default: 'ab'

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: üóëÔ∏è –û—á–∏—Å—Ç–∫–∞ –º–µ—Å—Ç–∞ (Free Disk Space)
        run: |
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf "$AGENT_TOOLSDIRECTORY"
          sudo docker image prune --all --force
          sudo apt-get clean
          df -h

      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget zip unzip curl axel python3 python3-pip openjdk-11-jdk
          sudo apt-get install -y android-sdk-libsparse-utils e2fsprogs simg2img img2simg p7zip-full
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ erofs-utils –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ–±—Ä–∞–∑–∞–º–∏ HyperOS
          sudo apt-get install -y erofs-utils
          pip3 install protobuf

      - name: ‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ (Xiaoxindada & Payload Dumper)
        run: |
          # –ö–ª–æ–Ω–∏—Ä—É–µ–º SGSI tool
          git clone --recurse-submodules https://github.com/xiaoxindada/sgsi-build-tool.git tool
          sudo chmod -R 777 tool
          
          # –°–∫–∞—á–∏–≤–∞–µ–º payload-dumper-go
          wget https://github.com/ssut/payload-dumper-go/releases/download/1.2.2/payload-dumper-go_1.2.2_linux_amd64.tar.gz
          tar -xvf payload-dumper-go_1.2.2_linux_amd64.tar.gz
          sudo mv payload-dumper-go /usr/local/bin/
          rm payload-dumper-go_1.2.2_linux_amd64.tar.gz

      - name: ‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∏ —Ä–∞—Å–ø–∞–∫–æ–≤–∫–∞ –ø—Ä–æ—à–∏–≤–∫–∏
        run: |
          cd tool
          echo "–°–∫–∞—á–∏–≤–∞–µ–º ROM..."
          axel -n 16 "${{ github.event.inputs.rom_url }}" -o firmware.zip || wget -O firmware.zip "${{ github.event.inputs.rom_url }}"
          
          echo "–†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞..."
          unzip firmware.zip -d firmware_extracted
          
          if [ -f "firmware_extracted/payload.bin" ]; then
            echo "–ù–∞–π–¥–µ–Ω payload.bin. –ò–∑–≤–ª–µ–∫–∞–µ–º system.img..."
            payload-dumper-go -p system -o . firmware_extracted/payload.bin
            # –ü–µ—Ä–µ–º–µ—â–∞–µ–º –∏–∑–≤–ª–µ—á–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ –∫–æ—Ä–µ–Ω—å –ø–∞–ø–∫–∏ tool
            mv system.img system_orig.img
          else
            echo "‚ùå –û—à–∏–±–∫–∞: payload.bin –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–∫—Ä–∏–ø—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–≤—ã–µ ROM."
            exit 1
          fi

      - name: üîÑ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è EROFS –≤ EXT4 (HyperOS Fix)
        run: |
          cd tool
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º magic bytes, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ñ–∞–π–ª EROFS
          MAGIC=$(head -c 4 system_orig.img | xxd -p)
          
          if [[ "$MAGIC" == "e2e1f5e0" ]]; then
            echo "‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω —Ñ–æ—Ä–º–∞—Ç EROFS. –ù–∞—á–∏–Ω–∞–µ–º –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—é –≤ EXT4..."
            
            # –°–æ–∑–¥–∞–µ–º –ø—É—Å—Ç–æ–π –æ–±—Ä–∞–∑ ext4 (—Ä–∞–∑–º–µ—Ä –±–µ—Ä–µ–º —Å –∑–∞–ø–∞—Å–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä 5GB, –∏–ª–∏ –≤—ã—á–∏—Å–ª—è–µ–º)
            # HyperOS system –æ–±—ã—á–Ω–æ –≤–µ—Å–∏—Ç 3-4GB, –¥–µ–ª–∞–µ–º 6GB –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏
            dd if=/dev/zero of=system.img bs=1M count=6144
            mkfs.ext4 system.img
            
            # –ú–æ–Ω—Ç–∏—Ä—É–µ–º EROFS –∏ –Ω–æ–≤—ã–π EXT4
            mkdir -p mnt_erofs mnt_ext4
            sudo mount -t erofs -o loop system_orig.img mnt_erofs
            sudo mount -t ext4 -o loop,rw system.img mnt_ext4
            
            echo "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
            sudo cp -a mnt_erofs/* mnt_ext4/
            
            echo "–†–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ..."
            sudo umount mnt_erofs
            sudo umount mnt_ext4
            
            # –£–¥–∞–ª—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –º–µ—Å—Ç–∞
            rm system_orig.img
            echo "‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. system.img —Ç–µ–ø–µ—Ä—å EXT4."
          else
            echo "‚ÑπÔ∏è –§–æ—Ä–º–∞—Ç –Ω–µ EROFS (–∏–ª–∏ —É–∂–µ raw/sparse). –ò—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å."
            mv system_orig.img system.img
          fi
          
          # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –¥–µ–ª–∞–µ–º simg2img, –µ—Å–ª–∏ –≤–¥—Ä—É–≥ —ç—Ç–æ sparse ext4, –∞ –Ω–µ raw
          if file system.img | grep -q "sparse"; then
             echo "–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Sparse -> Raw..."
             simg2img system.img system_raw.img
             mv system_raw.img system.img
          fi

      - name: üõ†Ô∏è –°–±–æ—Ä–∫–∞ SGSI
        run: |
          cd tool
          echo "–ó–∞–ø—É—Å–∫ make.sh..."
          # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É. –í–∞–∂–Ω–æ: —Å–∫—Ä–∏–ø—Ç –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å sudo –¥–ª—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          sudo ./make.sh --${{ github.event.inputs.os_type }} system.img
          
          if [ ! -f "SGSI.img" ]; then
             echo "‚ùå –û—à–∏–±–∫–∞: SGSI.img –Ω–µ –±—ã–ª —Å–æ–∑–¥–∞–Ω. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–±–æ—Ä–∫–∏."
             exit 1
          fi
          echo "‚úÖ –ë–∞–∑–æ–≤–∞—è —Å–±–æ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞."

      - name: üîß –ü–ê–¢–ß–ò–ù–ì (Alioth Specific & Cleanup)
        run: |
          cd tool
          
          # –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ SGSI.img —ç—Ç–æ raw image –¥–ª—è –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
          if file SGSI.img | grep -q "sparse"; then
            simg2img SGSI.img SGSI_raw.img
            mv SGSI_raw.img SGSI.img
          fi

          # –†–∞—Å—à–∏—Ä—è–µ–º –æ–±—Ä–∞–∑ –ø–µ—Ä–µ–¥ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º
          e2fsck -f -y SGSI.img
          resize2fs SGSI.img 5000M || true

          mkdir -p mount_point
          sudo mount -t ext4 -o loop,rw SGSI.img mount_point
          
          echo ">>> –£–¥–∞–ª–µ–Ω–∏–µ Bloatware (MiVideo, MiMusic)..."
          sudo rm -rf mount_point/system/app/MiVideo
          sudo rm -rf mount_point/system/app/MiMusic
          sudo rm -rf mount_point/system/priv-app/MiBrowserGlobal
          
          echo ">>> –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ Build.prop —Ç–≤–∏–∫–æ–≤ –¥–ª—è Alioth..."
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º >> –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∏–ª–∏ sed –¥–ª—è –∑–∞–º–µ–Ω—ã. Sed –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –µ—Å–ª–∏ —Å—Ç—Ä–æ–∫–∏ —É–∂–µ –µ—Å—Ç—å.
          sudo sed -i 's/^ro.product.model=.*/ro.product.model=M2012K11AC/' mount_point/system/build.prop || echo "ro.product.model=M2012K11AC" | sudo tee -a mount_point/system/build.prop
          sudo sed -i 's/^ro.product.brand=.*/ro.product.brand=POCO/' mount_point/system/build.prop || echo "ro.product.brand=POCO" | sudo tee -a mount_point/system/build.prop
          sudo sed -i 's/^ro.product.name=.*/ro.product.name=alioth/' mount_point/system/build.prop || echo "ro.product.name=alioth" | sudo tee -a mount_point/system/build.prop
          sudo sed -i 's/^ro.product.device=.*/ro.product.device=alioth/' mount_point/system/build.prop || echo "ro.product.device=alioth" | sudo tee -a mount_point/system/build.prop

          echo ">>> –§–∏–∫—Å RW (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–µ–Ω)..."
          if [ -f "mount_point/system/etc/fstab.qcom" ]; then
             sudo sed -i 's/,ro/,rw/g' mount_point/system/etc/fstab.qcom
          fi
          
          # –û—á–∏—Å—Ç–∫–∞ lost+found –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã
          sudo rm -rf mount_point/lost+found

          sudo umount mount_point
          
          echo ">>> –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–∑–º–µ—Ä–∞ (Shrink)..."
          resize2fs -M SGSI.img
          
          echo ">>> –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ Sparse (–¥–ª—è fastboot)..."
          img2simg SGSI.img SGSI_Alioth_Patched.img
          rm SGSI.img

      - name: üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        uses: actions/upload-artifact@v4
        with:
          name: HOS_SGSI_Alioth
          path: tool/SGSI_Alioth_Patched.img
