name: HyperOS to SGSI (Alioth)

on:
  workflow_dispatch:
    inputs:
      ROM_URL:
        description: 'Ссылка на Recovery (zip) или Fastboot (tgz) прошивку HyperOS'
        required: true
      OS_TYPE:
        description: 'Тип разметки (для Alioth выбирай AB)'
        required: true
        default: 'ab'
        type: choice
        options:
        - ab
        - a
      REPACK_NAME:
        description: 'Имя выходного файла'
        required: true
        default: 'HyperOS_SGSI'

jobs:
  build:
    runs-on: ubuntu-20.04 # 20.04 самая надежная для сборки GSI
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # 1. ОЧИСТКА МЕСТА (Для HyperOS это ОБЯЗАТЕЛЬНО, она весит >5ГБ в архиве)
      - name: Cleanup Disk Space
        uses: rokibhasansagar/slimhub_actions@main
        with:
          retain: "podman,docker_buildx"

      # 2. УСТАНОВКА ИНСТРУМЕНТОВ
      - name: Install Tools & Dependencies
        run: |
          sudo apt-get update
          sudo apt-get -y install git unzip zip curl wget python3 python3-pip aria2 zstd
          sudo apt-get -y install android-sdk-libsparse-utils # simg2img для fastboot ромов
          sudo apt-get -y install openjdk-8-jdk
          
          # Специфично для HyperOS (работа с EROFS)
          sudo apt-get -y install erofs-utils
          
          # Python зависимости
          pip3 install --upgrade pip
          pip3 install protobuf requests docopt

      # 3. НАСТРОЙКА ИНСТРУМЕНТА СБОРКИ (Xiaoxindada - лучший для MIUI/HyperOS)
      - name: Setup SGSI Tool
        run: |
          git clone --recurse-submodules https://github.com/Xiaoxindada/SGSI-Build-Tool.git tool
          sudo chmod -R 777 tool
          
      # 4. СКАЧИВАНИЕ ПРОШИВКИ
      - name: Download HyperOS Firmware
        working-directory: ./tool
        run: |
          echo "Downloading: ${{ inputs.ROM_URL }}"
          # Используем aria2c для скорости
          aria2c -x16 -s16 -o firmware.zip "${{ inputs.ROM_URL }}"
          ls -lh firmware.zip

      # 5. СБОРКА SGSI
      - name: Build SGSI
        working-directory: ./tool
        run: |
          # Запуск скрипта. 
          # --fix-bug включает фиксы для китайских прошивок
          # Скрипт сам определит, payload.bin это или fastboot images
          sudo bash ./make.sh --url firmware.zip --type ${{ inputs.OS_TYPE }} --fix-bug

      # 6. ПРОВЕРКА И УПАКОВКА
      - name: Repack Output
        working-directory: ./tool
        run: |
          if ls SGSI/*.img 1> /dev/null 2>&1; then
            echo "Build Success! Packing..."
            cd SGSI
            # HyperOS образы большие, сжимаем сильно
            7z a -t7z -m0=lzma2 -mx=9 -mfb=64 -md=32m -ms=on ${{ inputs.REPACK_NAME }}.7z *.img
            mv ${{ inputs.REPACK_NAME }}.7z ../
          else
            echo "::error::Build failed! No .img file found inside SGSI folder."
            ls -R
            exit 1
          fi

      # 7. ЗАГРУЗКА РЕЛИЗА
      - name: Upload to Github Releases
        uses: ncipollo/release-action@v1
        with:
          artifacts: "tool/${{ inputs.REPACK_NAME }}.7z"
          tag: "HyperOS_${{ github.run_number }}"
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            **HyperOS SGSI Build for Alioth**
            Source URL: ${{ inputs.ROM_URL }}
            Partition Type: ${{ inputs.OS_TYPE }}
            Date: ${{ steps.date.outputs.date }}
