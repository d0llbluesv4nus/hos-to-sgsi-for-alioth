name: Build HyperOS SGSI for Poco F3 (Manual Clean)

on:
  workflow_dispatch:
    inputs:
      rom_url:
        description: 'Прямая ссылка на Recovery ROM HyperOS (Source Device)'
        required: true
        default: ''
      os_type:
        description: 'Версия Android (14 или 15)'
        required: true
        default: '14'

jobs:
  build:
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # --- ИСПРАВЛЕНИЕ: РУЧНАЯ ОЧИСТКА МЕСТА ---
      # Мы не используем сторонние экшены, удаляем лишнее сами.
      # Это освободит около 20 ГБ места.
      - name: Ручная очистка места (Manual Cleanup)
        run: |
          echo "Очистка места на диске..."
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /usr/share/swift
          sudo docker rmi $(docker images -q) 2>/dev/null || true
          sudo apt-get clean
          echo "Очистка завершена. Свободное место:"
          df -h
      # -----------------------------------------

      - name: Установка зависимостей
        run: |
          sudo apt-get update
          sudo apt-get install -y git wget curl unzip tar android-sdk-libsparse-utils e2fsprogs simg2img img2simg python3 python3-pip aria2 brotli
          pip3 install protobuf==3.20.*

      - name: Настройка SGSI Tool (Xiaoxindada)
        run: |
          # Ветка 15 для Android 14/15
          git clone --recurse-submodules https://github.com/Xiaoxindada/SGSI-build-tool.git -b 15
          sudo chmod -R 777 SGSI-build-tool

      - name: Скачивание прошивки
        run: |
          cd SGSI-build-tool
          echo "Скачивание прошивки..."
          aria2c -x16 -s16 -o firmware.zip "${{ github.event.inputs.rom_url }}"
          
      - name: Сборка образа (Build SGSI)
        run: |
          cd SGSI-build-tool
          
          # 1. Распаковка
          ./unpack.sh firmware.zip
          
          # 2. Сборка (AB - так как Poco F3 это AB устройство)
          sudo ./make.sh AB
          
      - name: ПРИМЕНЕНИЕ ПАТЧЕЙ (Fixes for Alioth)
        run: |
          cd SGSI-build-tool
          mkdir -p mount_point
          
          # Ищем готовый образ
          IMG_FILE=$(find . -name "*system*.img" | head -n 1)
          
          if [ -f "$IMG_FILE" ]; then
            echo "Образ найден: $IMG_FILE. Начинаем патчинг..."
            
            # Если образ в sparse формате, конвертируем в raw для монтирования
            if file "$IMG_FILE" | grep -q "Android sparse image"; then
                simg2img "$IMG_FILE" system_raw.img
                rm "$IMG_FILE"
                mv system_raw.img "$IMG_FILE"
            fi
            
            # Монтируем
            sudo mount -o loop,rw "$IMG_FILE" mount_point
            
            echo ">>> [PATCH 1] Отключение Secure Boot и включение Debuggable"
            # Это критично для отладки бутлупов
            sudo sed -i 's/ro.secure=1/ro.secure=0/g' mount_point/system/build.prop || true
            sudo sed -i 's/ro.debuggable=0/ro.debuggable=1/g' mount_point/system/build.prop || true
            sudo sed -i 's/ro.adb.secure=1/ro.adb.secure=0/g' mount_point/system/build.prop || true
            
            echo ">>> [PATCH 2] Удаление оверлеев (DeviceConfig)"
            # Удаляем специфичные конфиги донора, чтобы не ломать интерфейс Poco F3
            sudo rm -rf mount_point/product/overlay/DeviceConfig*.apk || true
            
            echo ">>> [PATCH 3] Отключение шифрования (fstab)"
            if [ -f mount_point/system/etc/fstab* ]; then
                sudo sed -i 's/fileencryption//g' mount_point/system/etc/fstab*
                sudo sed -i 's/forceencrypt//g' mount_point/system/etc/fstab*
                sudo sed -i 's/dm-verity//g' mount_point/system/etc/fstab*
            fi
            
            # Удаление сервисов, часто вызывающих сбои на портах
            echo ">>> [PATCH 4] Удаление MiTrustService (опционально)"
            sudo rm -rf mount_point/system/app/MiTrustService || true

            sudo umount mount_point
            echo "Патчи применены."
            
            # Сжимаем обратно в sparse для быстрой загрузки и прошивки
            img2simg "$IMG_FILE" system_patched.img
            rm "$IMG_FILE"
          else
            echo "ERROR: System image not found! Сборка не удалась."
            exit 1
          fi

      - name: Упаковка и загрузка
        uses: actions/upload-artifact@v4
        with:
          name: HyperOS-Alioth-Port
          path: SGSI-build-tool/system_patched.img
          compression-level: 9
